<% layout("layouts/boilerplate") %>

<h2 class="text-3xl font-semibold mb-2">
  ðŸ¤– <span class="text-accent">HelperBot</span>
</h2>

<p class="text-muted mb-6">
  Ask any academic or general knowledge question
</p>

<% if (error) { %>
  <div class="mb-6 p-4 rounded-xl bg-red-500/10 border border-red-500/30 text-red-400 text-sm">
    <%= error %>
  </div>
<% } %>

<!-- Clear Chat -->
<% if (chatHistory && chatHistory.length > 0) { %>
  <form action="/helperbot/clear" method="POST" class="mb-4">
    <button
      type="submit"
      class="px-4 py-2 text-xs rounded-lg border border-red-400/40 text-red-400 hover:bg-red-500/10 transition"
    >
      ðŸ—‘ Clear Chat
    </button>
  </form>
<% } %>

<!-- Chat Window -->
<div class="form-panel mb-8">
  <div id="chatWindow" class="space-y-4 max-h-[450px] overflow-y-auto pr-2">

    <% if (chatHistory && chatHistory.length > 0) { %>
      <% chatHistory.forEach(function(msg) { %>
        <div class="flex <%= msg.role === 'user' ? 'justify-end' : 'justify-start' %>">
          <div class="
            max-w-[70%] px-4 py-3 rounded-2xl text-sm whitespace-pre-wrap
            <%= msg.role === 'user'
              ? 'bg-accent text-white'
              : 'bg-bg border border-white/10 text-gray-200' %>
          ">
            <%= msg.content %>
          </div>
        </div>
      <% }); %>
    <% } else { %>
      <p class="text-muted text-sm">Start the conversation...</p>
    <% } %>

    <div id="typingIndicator" class="hidden text-sm text-muted mt-3">
      Revizo is thinking...
    </div>

  </div>
</div>

<!-- Ask Form -->
<div class="form-panel mb-8">
  <form id="chatForm" action="/helperbot/ask" method="POST" class="space-y-5">
    <textarea
      id="chatInput"
      name="question"
      rows="3"
      placeholder="Type your message..."
      required
      class="form-input form-textarea"
    ></textarea>

    <button id="sendBtn" type="submit" class="form-button text-white">
      Send
    </button>
  </form>
</div>

<!-- Email -->
<% if (chatHistory && chatHistory.length > 1) { %>
  <div class="form-panel mb-10">
    <form action="/helperbot/email" method="POST" class="flex gap-4">
      <input
        type="email"
        name="email"
        placeholder="Enter email"
        required
        class="form-input flex-1"
      >
      <button
        type="submit"
        class="px-6 py-2 rounded-xl border border-white/10 text-sm hover:border-accent hover:text-accent transition"
      >
        ðŸ“§ Send Last Chat
      </button>
    </form>
  </div>
<% } %>

<a href="/" class="inline-block text-sm text-muted hover:text-accent transition">
  â¬… Back to Home
</a>

<script>
document.addEventListener("DOMContentLoaded", function () {

  const textarea = document.getElementById("chatInput");
  const form = document.getElementById("chatForm");
  const chatWindow = document.getElementById("chatWindow");
  const typing = document.getElementById("typingIndicator");
  const sendBtn = document.getElementById("sendBtn");

  if (chatWindow) {
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }

  if (textarea) {
    textarea.focus();
  }

  textarea.addEventListener("keydown", function (e) {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      form.submit();
    }
  });

  form.addEventListener("submit", function () {
    typing.classList.remove("hidden");
    textarea.disabled = true;
    sendBtn.disabled = true;
  });

});
</script>
